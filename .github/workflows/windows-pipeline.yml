name: Windows Pipeline

on:
  workflow_call:
    inputs:
      compiler:
        required: true
        type: string
      backend:
        required: true
        type: string
      run_tests:
        required: true
        type: boolean

jobs:
  build:
    name: Windows (${{ inputs.compiler }}-${{ inputs.backend }})
    runs-on: windows-latest
    defaults:
      run:
        shell: bash # Forces Git Bash for consistency with Linux scripts

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/install-core-deps
        with:
          backend: ArrayFire
      
      - name: Install CUDA 12.3.0 (Micromamba)
        if: inputs.backend == 'cuda'
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: cuda-env
          # 'nvidia' channel contains the full official toolkit with nvcc.
          # We use 'cuda-toolkit' specifically to get the compiler + tools.
          condarc: |
            channels:
              - nvidia
              - conda-forge
          create-args: >-
            cuda-toolkit=12.3.0
          cache-environment: true
          # initializes 'nvcc' in the path for subsequent steps
          init-shell: powershell 

      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      
      - name: Install CMake & Ninja
        run: pip install --upgrade cmake ninja
      
      - uses: ./.github/actions/setup-windows
        with:
          compiler: ${{ inputs.compiler }}

      - name: Build
        uses: ./.github/actions/core-build
        with:
          cache_prefix: windows
          compiler: ${{ inputs.compiler }}
          backend: ${{ inputs.backend }}

      - name: Test
        if: inputs.run_tests
        uses: ./.github/actions/core-test
        with:
          test_dir: out/build/ci_${{ inputs.compiler }}_af_${{ inputs.backend }}